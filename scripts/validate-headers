#!/bin/bash
# validate-headers - Check for non-modular header includes
#
# This script builds Backpack with BUILD_LIBRARY_FOR_DISTRIBUTION=YES
# to detect non-modular header includes that would cause issues for consumers.
#
# Usage:
#   ./scripts/validate-headers          # Run both SPM and CocoaPods checks
#   ./scripts/validate-headers spm      # Run only SPM check
#   ./scripts/validate-headers pods     # Run only CocoaPods check

set -eo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Determine simulator destination
if xcrun simctl list devices available | grep -q "iPhone SE (3rd generation)"; then
    DESTINATION="platform=iOS Simulator,name=iPhone SE (3rd generation)"
else
    # Fallback to any available iPhone
    DESTINATION="platform=iOS Simulator,name=iPhone 15"
fi

# Create temp directory for build logs
BUILD_LOG=$(mktemp)
trap "rm -f $BUILD_LOG; rm -rf .derivedData" EXIT

FAILED=0

validate_spm() {
    echo -e "\n${BLUE}=== Validating SPM headers ===${NC}"
    echo "Destination: $DESTINATION"

    if xcodebuild \
        -workspace .swiftpm/xcode/package.xcworkspace \
        -scheme Backpack-Package \
        -destination "$DESTINATION" \
        -derivedDataPath .derivedData \
        -skipPackagePluginValidation \
        -skipMacroValidation \
        BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
        SWIFT_EMIT_MODULE_INTERFACE=NO \
        ENABLE_TESTABILITY=NO \
        build 2>&1 | tee "$BUILD_LOG" | grep -E "(error:|BUILD|Compiling)" ; then

        # Check for non-modular header warnings/errors (actual errors, not compiler flags)
        if grep -E "(error|warning):.*include of non-modular" "$BUILD_LOG"; then
            echo -e "\n${RED}ERROR: Non-modular header includes detected in SPM!${NC}"
            FAILED=1
        else
            echo -e "\n${GREEN}SPM: No non-modular header issues detected!${NC}"
        fi
    else
        echo -e "\n${RED}ERROR: SPM build failed!${NC}"
        FAILED=1
    fi

    rm -rf .derivedData
}

validate_pods() {
    echo -e "\n${BLUE}=== Validating CocoaPods headers ===${NC}"

    # Check if pods are installed
    if [ ! -d "Example/Pods" ]; then
        echo "Installing pods..."
        (cd Example && bundle exec pod install)
    fi

    local schemes=("Backpack Native" "Backpack SwiftUI" "Backpack-Common")

    for scheme in "${schemes[@]}"; do
        echo -e "\n${YELLOW}Building scheme: $scheme${NC}"

        if xcodebuild \
            -workspace Example/Backpack.xcworkspace \
            -scheme "$scheme" \
            -destination "$DESTINATION" \
            -derivedDataPath .derivedData \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            SWIFT_EMIT_MODULE_INTERFACE=NO \
            ENABLE_TESTABILITY=NO \
            ONLY_ACTIVE_ARCH=YES \
            build 2>&1 | tee "$BUILD_LOG" | grep -E "(error:|BUILD|Compiling)" ; then

            # Check for non-modular header warnings/errors
            if grep -E "(error|warning):.*include of non-modular" "$BUILD_LOG"; then
                echo -e "${RED}ERROR: Non-modular header includes detected in $scheme!${NC}"
                FAILED=1
            else
                echo -e "${GREEN}$scheme: No non-modular header issues detected!${NC}"
            fi
        else
            echo -e "${RED}ERROR: $scheme build failed!${NC}"
            FAILED=1
        fi

        rm -rf .derivedData
    done
}

# Main
echo -e "${YELLOW}Validating headers for non-modular includes...${NC}"

case "${1:-all}" in
    spm)
        validate_spm
        ;;
    pods)
        validate_pods
        ;;
    all|*)
        validate_spm
        validate_pods
        ;;
esac

if [ $FAILED -eq 0 ]; then
    echo -e "\n${GREEN}SUCCESS: All validations passed!${NC}"
    exit 0
else
    echo -e "\n${RED}FAILED: Some validations failed!${NC}"
    echo -e "${YELLOW}Fix: Ensure headers use proper conditional imports with #ifdef SWIFT_PACKAGE${NC}"
    exit 1
fi
