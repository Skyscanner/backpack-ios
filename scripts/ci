#!/bin/bash
set -e

EXAMPLE_WORKSPACE="Example/Backpack.xcworkspace"
SWIFT=${SWIFT:-'5.0'}
BUILD_SDK=${BUILD_SDK:-'iphonesimulator'}
DESTINATION=${DESTINATION:-"platform=iOS Simulator,name=iPhone SE (3rd generation),OS=18.4"}

# --------------------------------------------------------------------
# UPDATED SIMULATOR-CREATION BLOCK (UDID-BASED)
# Ensures CI uses exactly one simulator by UDID, avoiding Xcode's
# "multiple devices matched" fatal error.
# --------------------------------------------------------------------

if [[ -n "$CI" && "$DESTINATION" == "platform=iOS Simulator,name=iPhone SE (3rd generation),OS=18.4" ]]; then
  RUNTIME_ID="com.apple.CoreSimulator.SimRuntime.iOS-18-4"
  DEVICE_TYPE_ID="com.apple.CoreSimulator.SimDeviceType.iPhone-SE-3rd-generation"
  DEVICE_NAME="CI iPhone SE (3rd generation) 18.4"

  echo "Ensuring CI simulator exists for: $DEVICE_NAME"

  # Try to find an existing device with this name & runtime
  EXISTING_UDID=$(xcrun simctl list devices "$RUNTIME_ID" | \
    awk -v name="$DEVICE_NAME" '
      index($0, name) {
        # Extract UDID from "(xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)"
        match($0, /\(([0-9A-Fa-f-]{36})\)/, m);
        if (m[1] != "") { print m[1]; exit }
      }
    ')

  if [[ -n "$EXISTING_UDID" ]]; then
    echo "Found existing simulator: $DEVICE_NAME (UDID: $EXISTING_UDID)"
    DEVICE_UDID="$EXISTING_UDID"
  else
    echo "Creating simulator: $DEVICE_NAME"
    DEVICE_UDID=$(xcrun simctl create "$DEVICE_NAME" "$DEVICE_TYPE_ID" "$RUNTIME_ID")
    echo "Created simulator with UDID: $DEVICE_UDID"
  fi

  # Use the UDID directly â†’ avoids ambiguous simulator name/OS failures
  DESTINATION="id=$DEVICE_UDID"
  echo "Using DESTINATION=\"$DESTINATION\""
fi

# --------------------------------------------------------------------

function analyze() {
    xcodebuild analyze \
        -workspace $EXAMPLE_WORKSPACE \
        -scheme "$1" \
        SWIFT_VERSION=$SWIFT \
        -sdk $BUILD_SDK \
        -destination "$(echo $DESTINATION)" \
        ONLY_ACTIVE_ARCH=YES 2>&1
}

function runTests() {
    local scheme="$1"
    shift

    xcodebuild test \
        -enableCodeCoverage YES \
        -workspace $EXAMPLE_WORKSPACE \
        -scheme "$scheme" \
        SWIFT_VERSION=$SWIFT \
        -sdk $BUILD_SDK \
        -destination "$(echo $DESTINATION)" \
        ONLY_ACTIVE_ARCH=YES \
        "$@" 2>&1
}

function check_modules() {
    if [ $2 == "test" ]; then
        if [ $1 == "uikit" ]; then
            runTests "Backpack-Snapshot-Tests"
            runTests "Backpack-Unit-Tests"

        elif [ $1 == "uitests" ]; then
            runTests "Backpack-UI-Tests"

        elif [ $1 == "swiftui" ]; then
            runTests "Backpack SwiftUI"

        elif [ $1 == "common" ]; then
            runTests "Backpack-Common-Tests"
        fi
    elif [ $2 == "analysis" ]; then
        if [ $1 == "uikit" ]; then
            analyze "Backpack Native"

        elif [ $1 == "swiftui" ]; then
            analyze "Backpack SwiftUI"

        elif [ $1 == "common" ]; then
            analyze "Backpack-Common"
        fi
    fi
}

if [ $# -lt 2 ]; then
    echo "No arguments provided. Running all tests."
    check_modules "uikit" "test"
    check_modules "swiftui" "test"
    check_modules "common" "test"
    check_modules "uitests" "test"
else
    check_modules $1 $2
fi
