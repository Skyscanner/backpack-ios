name: _spm-test

on:
  workflow_call:

defaults:
  run:
    shell: bash -l {0}

jobs:
  spm-test-build:
    name: SwiftPM Test Build
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Select Xcode 16
        run: sudo xcode-select --switch /Applications/Xcode_16.2.app

      - name: Prepare SwiftPM Xcode workspace
        run: |
          set -eo pipefail
          mkdir -p .swiftpm/xcode/package.xcworkspace
          cat <<'EOF' > .swiftpm/xcode/package.xcworkspace/contents.xcworkspacedata
          <?xml version="1.0" encoding="UTF-8"?>
          <Workspace
             version = "1.0">
             <FileRef
                location = "self:">
             </FileRef>
          </Workspace>
          EOF

      - name: Run Backpack Swift Package tests
        env:
          SPM_DESTINATION: platform=iOS Simulator,name=iPhone SE (3rd generation),OS=17.5
        run: |
          set -eo pipefail
          xcodebuild \
            -workspace .swiftpm/xcode/package.xcworkspace \
            -scheme Backpack-Package \
            -destination "$SPM_DESTINATION" \
            -derivedDataPath .derivedData \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            test

      - name: Clean derived data
        if: always()
        run: rm -rf .derivedData
