name: _archive-validation

on:
  workflow_call:

defaults:
  run:
    shell: bash -l {0}

env:
  DESTINATION: ${DESTINATION:-"platform=iOS Simulator,name=iPhone SE (3rd generation),OS=17.5"}

jobs:
  archive-validation:
    name: Archive Validation (Non-modular Headers Check)
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup SwiftPM workspace
        uses: ./.github/actions/spm-setup

      - name: Select Xcode 16
        run: sudo xcode-select --switch /Applications/Xcode_16.2.app

      - name: Build with Distribution Settings
        run: |
          set -eo pipefail
          # BUILD_LIBRARY_FOR_DISTRIBUTION=YES enables stricter checking for framework distribution
          # SWIFT_EMIT_MODULE_INTERFACE=NO prevents interface verification failures with mixed Swift/ObjC
          # The non-modular header check happens at compile time, not during interface verification
          xcodebuild \
            -workspace .swiftpm/xcode/package.xcworkspace \
            -scheme Backpack-Package \
            -destination "$DESTINATION" \
            -derivedDataPath .derivedData \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            SWIFT_EMIT_MODULE_INTERFACE=NO \
            ENABLE_TESTABILITY=NO \
            build 2>&1 | tee build.log

          # Check for non-modular header warnings/errors (actual errors, not compiler flags)
          # Pattern matches "error: include of non-modular" or "warning: include of non-modular"
          # but NOT "-Wnon-modular-include-in-framework-module" compiler flags
          if grep -E "(error|warning):.*include of non-modular" build.log; then
            echo "::error::Non-modular header includes detected!"
            exit 1
          fi

          echo "No non-modular header issues detected"

      - name: Clean derived data
        if: always()
        run: rm -rf .derivedData build.log
