name: _archive-validation

on:
  workflow_call:

defaults:
  run:
    shell: bash -l {0}

jobs:
  archive-validation:
    name: Archive Validation (Non-modular Headers Check)
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup SwiftPM workspace
        uses: ./.github/actions/spm-setup

      - name: Select Xcode 16
        run: sudo xcode-select --switch /Applications/Xcode_16.2.app

      - name: Build with Distribution Settings
        env:
          SPM_DESTINATION: platform=iOS Simulator,name=iPhone SE (3rd generation),OS=18.2
        run: |
          set -eo pipefail
          xcodebuild \
            -workspace .swiftpm/xcode/package.xcworkspace \
            -scheme Backpack-Package \
            -destination "$SPM_DESTINATION" \
            -derivedDataPath .derivedData \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            ENABLE_TESTABILITY=NO \
            build 2>&1 | tee build.log

          # Check for non-modular header warnings/errors
          if grep -q "non-modular-include-in-framework-module" build.log; then
            echo "::error::Non-modular header includes detected!"
            grep "non-modular-include-in-framework-module" build.log
            exit 1
          fi

          echo "No non-modular header issues detected"

      - name: Clean derived data
        if: always()
        run: rm -rf .derivedData build.log
