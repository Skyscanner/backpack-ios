name: Test

on:
  workflow_call:
    secrets:
      GH_APP_PRIVATE_KEY:
        required: true
    inputs:
      retake_snapshots:
        required: false
        default: false
        type: boolean

defaults:
  run:
    shell: bash -l {0}

permissions: {}

jobs:
  TestPods:
    name: Testing Pods
    runs-on: macos-15
    timeout-minutes: 40
    outputs:
      changed-files: ${{ steps.checkSnapshotChanges.outputs.didChangeFiles }}
    steps:
      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: false

      - name: Set up node and ruby
        uses: asdf-vm/actions/install@b7bcd026f18772e44fe1026d729e1611cc435d47 # v4.0.1

      - name: Cache Bundler install Gems
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ env.ImageVersion }}-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-${{ env.ImageVersion }}

      - name: Cache Pods
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: Example/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Bundle Install
        run: bundle install --jobs 4 --retry 3

      - name: Pod Install
        run: bundle exec pod install
        working-directory: Example

      - name: Select Xcode 16
        run: sudo xcode-select --switch /Applications/Xcode_16.4.app

      - name: Remove snapshots
        if: ${{inputs.retake_snapshots}}
        run: find . -type d -name "__Snapshots__" -exec rm -rf {}  +;

      - name: Run UIKit tests
        run: ./scripts/ci uikit test
        continue-on-error: ${{inputs.retake_snapshots}}

      - name: Run SwiftUI tests
        run: ./scripts/ci swiftui test
        continue-on-error: ${{inputs.retake_snapshots}}

      - name: Run Common tests
        run: ./scripts/ci common test
        continue-on-error: ${{inputs.retake_snapshots}}

      - name: Check snapshot changes
        id: checkSnapshotChanges
        run: changedFiles=`git status --porcelain` && echo "didChangeFiles=${changedFiles//$'\n'/'%0A'}" >> $GITHUB_OUTPUT

      - name: Save snapshots
        if: ${{inputs.retake_snapshots}}
        env:
          TOKEN: ${{ steps.app-token.outputs.token }}
          REPOSITORY: ${{ github.repository }}
        run: |
          git config --local user.email "197108191+skyscanner-backpack-bot[bot]@users.noreply.github.com"
          git config --local user.name "skyscanner-backpack-bot[bot]"
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${REPOSITORY}.git
          git fetch origin $GITHUB_HEAD_REF
          git checkout $GITHUB_HEAD_REF
          git add --ignore-removal */**/__Snapshots__/*.png
          git diff-index --quiet HEAD || git commit -m "Updated snapshots"
          git push

  TestSwiftPM:
    name: SwiftPM Tests
    uses: ./.github/workflows/_spm-test.yml

  NotifyChanges:
    name: "Notify about changes made"
    runs-on: ubuntu-22.04
    needs: [TestPods]
    if: ${{ needs.TestPods.outputs.changed-files != '' &&  inputs.retake_snapshots}}
    steps:
      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Notify PR of screenshots changes
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          CHANGED_FILES: ${{ needs.TestPods.outputs.changed-files }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            var body = `### Snapshots were updated. Please verify the changes match the expected layout. \n\n>'${process.env.CHANGED_FILES}'`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
